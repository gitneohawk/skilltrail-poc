<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIã‚­ãƒ£ãƒªã‚¢è¨ºæ–­ | SkillTrail</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Raleway:wght@600;700&display=swap" rel="stylesheet">
    <link href="./dist/output.css" rel="stylesheet" />
    <style>
      /* ã‚ˆã‚Šæ±ç”¨çš„ãªãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
      body {
        font-family: 'Noto Sans JP', 'Raleway', sans-serif;
      }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center p-4">
  <header class="flex justify-between items-center p-6 w-full max-w-3xl mx-auto">
    <a href="index.html" class="text-3xl font-bold text-orange-500">SkillTrail</a>
    <div id="headerAuth" class="text-sm text-gray-600">
      <span id="loginStatus">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªä¸­...</span>
    </div>
  </header>

  <main class="w-full max-w-3xl space-y-8">
    <header class="text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-orange-600 mb-2">AIã‚­ãƒ£ãƒªã‚¢è¨ºæ–­</h1>
      <p class="text-base md:text-lg text-gray-600">SkillTrailã§ã®ã‚„ã‚Šå–ã‚Šã‚’åŸºã«ã€AIãŒã‚ãªãŸã®ã‚­ãƒ£ãƒªã‚¢ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚</p>
    </header>

    <section id="profileSection" class="rounded-xl shadow-lg bg-white p-6 md:p-8">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-800">ã‚ãªãŸã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
        <button id="editProfileBtn" class="text-sm font-medium text-orange-600 hover:text-orange-800 transition-colors">
          æƒ…å ±ã‚’ç·¨é›†ã™ã‚‹
        </button>
      </div>

      <div id="loadingMessage" class="flex items-center space-x-3 text-gray-500">
        <svg class="animate-spin h-5 w-5 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p>è¨ºæ–­ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>

      <div id="profileDisplay" class="hidden space-y-4 text-sm">
        </div>
      
      <div id="missingInfoArea" class="hidden text-sm text-yellow-900 bg-yellow-100 p-4 rounded-lg mt-4">
        <p class="font-semibold">è¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€ä¸è¶³ã—ã¦ã„ã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        <ul id="missingInfoList" class="list-disc list-inside mt-2"></ul>
      </div>
    </section>

    <section id="profileFormSection" class="rounded-xl shadow-lg bg-white p-6 md:p-8 hidden">
      <h2 class="text-xl font-bold text-gray-800 mb-6">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æ›´æ–°</h2>
      <form id="profileForm" class="space-y-4">
        <div>
          <label for="age" class="block text-sm font-medium text-gray-700 mb-1">å¹´é½¢</label>
          <input type="text" id="age" name="age" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm placeholder-gray-400 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500" placeholder="ä¾‹: 30ä»£å¾ŒåŠ">
        </div>
        <div>
          <label for="skills" class="block text-sm font-medium text-gray-700 mb-1">ã‚¹ã‚­ãƒ«ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
          <input type="text" id="skills" name="skills" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm placeholder-gray-400 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500" placeholder="ä¾‹: JavaScript, Python, ãƒãƒ¼ãƒ ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ">
        </div>
        <div>
          <label for="careerGoals" class="block text-sm font-medium text-gray-700 mb-1">ã‚­ãƒ£ãƒªã‚¢ã®å¸Œæœ›ãƒ»ç›®æ¨™</label>
          <input type="text" id="careerGoals" name="careerGoals" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm placeholder-gray-400 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500" placeholder="ä¾‹: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ç›®æŒ‡ã™">
        </div>
        <div>
          <label for="personality" class="block text-sm font-medium text-gray-700 mb-1">æ€§æ ¼</label>
          <input type="text" id="personality" name="personality" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm placeholder-gray-400 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500" placeholder="ä¾‹: å¿è€å¼·ã„ã€äººã¨è©±ã™ã®ãŒå¾—æ„">
        </div>
        <div>
          <label for="workStyle" class="block text-sm font-medium text-gray-700 mb-1">åƒãæ–¹</label>
          <input type="text" id="workStyle" name="workStyle" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm placeholder-gray-400 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500" placeholder="ä¾‹: ãƒªãƒ¢ãƒ¼ãƒˆå‹¤å‹™å¸Œæœ›ã€ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹é‡è¦–">
        </div>
        <div>
          <label for="location" class="block text-sm font-medium text-gray-700 mb-1">å±…ä½åœ°</label>
          <input type="text" id="location" name="location" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm placeholder-gray-400 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500" placeholder="ä¾‹: æ±äº¬éƒ½">
        </div>
        <div class="flex justify-end items-center gap-x-3 pt-4">
          <button type="button" id="cancelEditBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-md shadow-sm transition-colors">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°</button>
        </div>
      </form>
    </section>

    <div class="text-center bg-white rounded-xl shadow-lg p-6 md:p-8">
      <p class="text-gray-600 mb-4">æº–å‚™ãŒã§ããŸã‚‰ã€è¨ºæ–­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
      <button id="runDiagnosis" class="w-full md:w-auto px-6 py-2 text-base font-medium text-white bg-orange-500 rounded-md hover:bg-orange-600 transition duration-300" disabled>
        è¨ºæ–­ã‚’é–‹å§‹
      </button>
      <p id="disabledReason" class="text-sm text-gray-500 mt-3 hidden">
        ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ã™ã¹ã¦å…¥åŠ›ã™ã‚‹ã¨è¨ºæ–­ã‚’é–‹å§‹ã§ãã¾ã™ã€‚
      </p>
    </div>

    <section id="resultSection" class="hidden space-y-6">
      <div id="spinner" class="text-center p-8">
        <svg class="animate-spin h-8 w-8 text-orange-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg text-gray-600">AIãŒã‚ãªãŸã®ã‚­ãƒ£ãƒªã‚¢ã‚’è¨ºæ–­ä¸­ã§ã™...</p>
      </div>

      <div id="diagnosisResult" class="hidden rounded-xl shadow-lg bg-white p-6 md:p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">è¨ºæ–­çµæœ</h2>
        <div id="diagnosisContent" class="prose prose-orange max-w-none text-gray-700 leading-relaxed">
        </div>
      </div>
    </section>
  </main>

  <script src="career-diagnosis.js"></script>
  <script>
window.addEventListener("DOMContentLoaded", () => {
  const loginEl = document.getElementById("loginStatus");
  const loadingMessage = document.getElementById("loadingMessage");
  const profileDisplay = document.getElementById("profileDisplay");
  const missingInfoArea = document.getElementById("missingInfoArea");
  const runDiagnosisBtn = document.getElementById("runDiagnosis");
  const disabledReason = document.getElementById("disabledReason");

  async function updateLoginStatus() {
    try {
      const res = await fetch("/.auth/me", { credentials: "include" });
      const data = await res.json();
      if (data.clientPrincipal) {
        loginEl.innerHTML = `âœ… ã‚ˆã†ã“ã ${data.clientPrincipal.userDetails} ã•ã‚“ï¼ <a href="#" onclick="sessionStorage.clear(); window.location.href='/.auth/logout?post_logout_redirect_uri=/'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>`;
      } else {
        loginEl.innerHTML = `<a href="/login.html?returnTo=/career-diagnosis.html">ãƒ­ã‚°ã‚¤ãƒ³</a>`;
      }
    } catch (e) {
      loginEl.innerHTML = `<a href="/login.html?returnTo=/career-diagnosis.html">ãƒ­ã‚°ã‚¤ãƒ³</a>`;
    }
  }

  async function loadProfile() {
    try {
      // ã“ã“ã§APIã‹ã‚‰profileã‚’å–å¾—
      const res = await fetch("/api/load-career-profile", { credentials: "include" });
      if (!res.ok) throw new Error("not found");
      const profile = await res.json();

      // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®è¡¨ç¤ºå‡¦ç†
      loadingMessage.classList.add("hidden");
      profileDisplay.classList.remove("hidden");
      // ...ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†…å®¹ã®æç”»å‡¦ç†...

      runDiagnosisBtn.disabled = false;
      runDiagnosisBtn.classList.remove("opacity-50", "cursor-not-allowed");
      disabledReason.classList.add("hidden");
    } catch (e) {
      // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
      loadingMessage.classList.add("hidden");
      profileDisplay.classList.add("hidden");
      missingInfoArea.classList.remove("hidden");
      missingInfoArea.innerHTML = `<p class="font-semibold text-red-700">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>`;
      runDiagnosisBtn.disabled = true;
      runDiagnosisBtn.classList.add("opacity-50", "cursor-not-allowed");
      runDiagnosisBtn.style.display = "none";
      disabledReason.classList.remove("hidden");
      disabledReason.textContent = "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€è¨ºæ–­ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã€‚";
    }
  }

  updateLoginStatus();
  loadProfile();
});
  </script>
</body>
</html>